name: deploy

on:
  pull_request:
    types: [synchronize, opened, reopened, closed]

env:
  SERVICE: preview-${{ github.event.number }}
  REGISTRY_HOSTNAME: asia.gcr.io
  GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
  GCP_REGION: asia-northeast1
  IMAGE: app-preview
  APP_ENV: "development"

jobs:
  preview:
    if: github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'synchronize'
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: ["15.6.0"]

    steps:
      - uses: actions/checkout@v2

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
          cache: "yarn"

      - name: print PR number
        run: echo "hello-$SERVICE"

      - uses: google-github-actions/setup-gcloud@master
        with:
          version: 335.0.0
          service_account_email: ${{ secrets.GCP_ACCOUNT_EMAIL }}
          service_account_key: ${{ secrets.GCP_ACCOUNT_KEY }}
          export_default_credentials: true

      - run: gcloud auth configure-docker

      - name: Docker Build
        run: |
          docker build \
            -f Dockerfile \
            --build-arg PREVIEW_ID=$SERVICE \
            -t $REGISTRY_HOSTNAME/$GCP_PROJECT/$IMAGE:$SERVICE .

      - name: Publish
        run: |
          docker push $REGISTRY_HOSTNAME/$GCP_PROJECT/$IMAGE:$SERVICE

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v0.4.0
        with:
          service: app-${{ env.SERVICE }}
          image: ${{ env.REGISTRY_HOSTNAME }}/${{ env.GCP_PROJECT }}/${{ env.IMAGE }}:${{ env.SERVICE }}
          region: ${{ env.GCP_REGION }}
          tag: ${{ env.SERVICE }}

      - name: Use Output
        run: curl "${{ steps.deploy.outputs.url }}"
